'use strict';

const assert = require('assert');
const Emitter = require('events');

const _state = Symbol('state');
const _transitions = Symbol('transitions');

/**
 * Simple state machine.
 */
module.exports = class StateMachine extends Emitter {
  /**
   * @class {StateMachine}
   * @param {Object} transitions State map.
   * @param {string} state Initial state.
   */
  constructor(transitions, state = null) {
    super();

    this[_state] = state;
    this[_transitions] = transitions;
  }

  /**
   * Get current state.
   * @returns {string}
   */
  get state() {
    return this[_state];
  }

  /**
   * Switch to the next state.
   * @param {string} state
   */
  next(state) {
    if (this.state !== null) {
      /** @type {Set} */
      const allowedStates = this[_transitions][this.state];

      assert(
        allowedStates.has(state),
        `Forbidden transition from ${this.state} to ${state}`
      );
    }

    this[_state] = state;
    this.emit(state);
  }
};
